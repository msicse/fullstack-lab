{% extends "base.html" %}

{% block title %}{{ book.title }} - Online Library{% endblock %}

{% block content %}

<!-- Breadcrumb Navigation -->
<nav class="mb-4">
  <div class="flex items-center space-x-2 text-sm text-gray-600">
    <a href="/" class="hover:text-library-green transition-colors">Home</a>
    <span>â€º</span>
    {% if book.category %}
      <a href="/?category={{ book.category.id }}" class="hover:text-library-green transition-colors">{{ book.category.name }}</a>
      <span>â€º</span>
    {% endif %}
    <span class="text-gray-900 font-medium">{{ book.title }}</span>
  </div>
</nav>

<!-- Main Layout with Sidebar -->
<div class="lg:flex lg:space-x-6">
  <!-- Main Content (Left Side) -->
  <div class="lg:w-2/3">
    <!-- Book Details Card -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
      <div class="md:flex">
        <!-- Book Cover -->
        <div class="md:w-2/5">
          <div class="relative">
            {% if book.cover_image %}
              <img src="{{ book.cover_image.url }}" class="w-full h-80 md:h-96 object-cover" alt="{{ book.title }} cover">
            {% else %}
              <div class="w-full h-80 md:h-96 bg-gradient-to-br from-gray-200 to-gray-400 flex items-center justify-center">
                <span class="text-8xl text-gray-500">ðŸ“–</span>
              </div>
            {% endif %}
            
            <!-- Category Badge -->
            {% if book.category %}
              <div class="absolute top-4 left-4">
                <span class="bg-library-green text-white px-3 py-1 rounded-full text-sm font-semibold shadow-lg">
                  {{ book.category.name }}
                </span>
              </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Book Information -->
        <div class="md:w-3/5 p-6">
          <!-- Title and Author -->
          <div class="mb-4">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ book.title }}</h1>
            <p class="text-lg text-gray-600">by <span class="font-semibold text-gray-800">{{ book.author }}</span></p>
          </div>

          <!-- Rating Section -->
          <div class="mb-4">
            <div class="flex items-center space-x-4">
              <div class="flex items-center">
                <div class="text-xl text-yellow-400 mr-2">
                  {% for i in "12345" %}
                    {% if forloop.counter <= book.average_rating|floatformat:0 %}â˜…{% else %}â˜†{% endif %}
                  {% endfor %}
                </div>
                <span class="text-lg font-semibold text-gray-800">{{ book.average_rating|floatformat:1 }}</span>
                <span class="text-gray-500 ml-1">/5</span>
              </div>
              <div class="text-gray-500 text-sm">
                ({{ book.reviews.count }} review{{ book.reviews.count|pluralize }})
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-2 mb-4">
            {% if user.is_authenticated and user_can_review %}
              {% if not user_has_reviewed %}
                <a href="#write-review" class="bg-library-green text-white px-4 py-2 rounded-lg hover:bg-library-dark transition-colors font-semibold text-sm">
                  ðŸŒ± Write Review
                </a>
              {% else %}
                <span class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-semibold text-sm">
                  âœ… Reviewed
                </span>
              {% endif %}
            {% elif user.is_authenticated and not user_can_review %}
              <span class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-semibold text-sm">
                ðŸš« Restricted
              </span>
            {% else %}
              <a href="{% url 'login' %}" class="bg-library-green text-white px-4 py-2 rounded-lg hover:bg-library-dark transition-colors font-semibold text-sm">
                Login
              </a>
            {% endif %}
            <a href="/" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors font-semibold text-sm">
               Back
            </a>
            {% if book.category %}
              <a href="/?category={{ book.category.id }}" class="bg-emerald-100 text-emerald-800 px-4 py-2 rounded-lg hover:bg-emerald-200 transition-colors font-semibold text-sm">
                More {{ book.category.name }}
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Description Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-3"> About This Book</h3>
      <p class="text-gray-700 leading-relaxed">{{ book.description }}</p>
    </div>

    <!-- Review Form -->
    {% if user.is_authenticated and user_can_review and not user_has_reviewed %}
    <div id="write-review" class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-bold text-gray-900 mb-4"> Write Your Review</h3>
      
      <form method="post" class="space-y-4">
        {% csrf_token %}
        
        <!-- Rating Selection -->
        <div>
          <label class="block font-semibold text-gray-900 mb-2">Your Rating</label>
          <div class="flex flex-wrap gap-2">
            {% for i in "12345" %}
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="rating" value="{{ i }}" class="hidden peer" {% if form_data.rating == i or i == "5" and not form_data.rating %}checked{% endif %}>
                <div class="flex items-center space-x-1 px-3 py-2 rounded-lg border border-gray-200 peer-checked:border-library-green peer-checked:bg-green-50 hover:bg-gray-50 transition-colors">
                  <span class="text-yellow-400">
                    {% for j in "12345" %}
                      {% if forloop.counter <= i|add:0 %}â˜…{% else %}â˜†{% endif %}
                    {% endfor %}
                  </span>
                  <span class="font-semibold text-gray-700 text-sm">{{ i }}</span>
                </div>
              </label>
            {% endfor %}
          </div>
        </div>
        
        <!-- Comment -->
        <div>
          <label for="comment" class="block font-semibold text-gray-900 mb-2">Your Review</label>
          <textarea 
            name="comment" 
            id="comment"
            rows="4" 
            placeholder="Share your thoughts about this book..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-library-green focus:border-transparent resize-vertical text-sm"
            required
          >{% if form_data.comment %}{{ form_data.comment }}{% endif %}</textarea>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" class="w-full bg-library-green text-white py-2 rounded-lg hover:bg-library-dark transition-colors font-semibold">
          Submit Review
        </button>
      </form>
    </div>
    {% elif user.is_authenticated and user_can_review and user_has_reviewed %}
    <!-- Already Reviewed Message -->
    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
      <div class="text-2xl mb-2">âœ…</div>
      <h3 class="font-semibold text-gray-900 mb-1">Thank you!</h3>
      <p class="text-gray-600 text-sm">You've already reviewed this book.</p>
    </div>
    {% elif user.is_authenticated and not user_can_review %}
    <!-- Access Restricted Message -->
    <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
      <div class="text-2xl mb-2">ðŸš«</div>
      <h3 class="font-semibold text-gray-900 mb-1">Review Access Restricted</h3>
      <p class="text-gray-600 text-sm">Contact admin for access.</p>
    </div>
    {% else %}
    <!-- Login Prompt -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
      <div class="text-2xl mb-2"></div>
      <h3 class="font-semibold text-gray-900 mb-2">Want to review?</h3>
      <div class="space-y-2">
        <a href="{% url 'login' %}" class="block bg-library-green text-white px-4 py-2 rounded-lg hover:bg-library-dark transition-colors font-semibold text-sm">
          Login
        </a>
        <a href="{% url 'signup' %}" class="block bg-white text-library-green border border-library-green px-4 py-2 rounded-lg hover:bg-green-50 transition-colors font-semibold text-sm">
          Sign Up
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Right Sidebar - Reviews -->
  <div class="lg:w-1/3 mt-6 lg:mt-0">
    <div class="bg-white rounded-xl shadow-lg sticky top-4">
      <div class="p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-900"> Reviews</h2>
        <p class="text-sm text-gray-500">{{ book.reviews.count }} review{{ book.reviews.count|pluralize }}</p>
      </div>
      
      <div class="p-4 max-h-96 overflow-y-auto">
        {% if book.reviews.all %}
          <div class="space-y-4">
            {% for review in book.reviews.all %}
            <div class="border-l-4 border-library-green bg-gray-50 p-3 rounded-r-lg">
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center space-x-2">
                  <!-- User Avatar -->
                  <div class="w-8 h-8 bg-library-green text-white rounded-full flex items-center justify-center font-bold text-xs">
                    {{ review.user.username|first|upper }}
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-900 text-sm">{{ review.user.first_name|default:review.user.username }}</h4>
                    <p class="text-xs text-gray-500">{{ review.created_at|date:"M d, Y" }}</p>
                  </div>
                </div>
                
                <!-- Rating -->
                <div class="flex items-center">
                  <div class="text-yellow-400 text-sm mr-1">
                    {% for i in "12345" %}
                      {% if forloop.counter <= review.rating %}â˜…{% else %}â˜†{% endif %}
                    {% endfor %}
                  </div>
                  <span class="text-gray-600 font-semibold text-xs">{{ review.rating }}/5</span>
                </div>
              </div>
              
              <p class="text-gray-700 text-sm leading-relaxed">{{ review.comment }}</p>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- Empty State -->
          <div class="text-center py-8">
            <div class="text-4xl mb-2"></div>
            <h3 class="font-semibold text-gray-600 mb-1">No reviews yet</h3>
            <p class="text-gray-500 text-sm">Be the first to review!</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced form handling and user experience
document.addEventListener('DOMContentLoaded', function() {
  // Smooth scroll to review form
  const writeReviewBtn = document.querySelector('a[href="#write-review"]');
  if (writeReviewBtn) {
    writeReviewBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const reviewForm = document.getElementById('write-review');
      if (reviewForm) {
        reviewForm.scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  }

  // Clear form after successful submission (if page was redirected with success message)
  const successMessage = document.querySelector('.alert-success');
  const reviewForm = document.getElementById('write-review');
  
  if (successMessage && reviewForm) {
    // Clear the form if there's a success message
    const commentField = document.getElementById('comment');
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    
    if (commentField) {
      commentField.value = '';
    }
    
    // Reset rating to default (5 stars)
    ratingInputs.forEach(input => {
      if (input.value === '5') {
        input.checked = true;
      } else {
        input.checked = false;
      }
    });
  }

  // Auto-hide success/error messages after 5 seconds
  const messages = document.querySelectorAll('.bg-red-100, .bg-green-100, .bg-yellow-100, .bg-blue-100');
  messages.forEach(message => {
    // Add initial smooth appearance
    message.style.opacity = '0';
    message.style.transform = 'translateY(-10px)';
    message.style.transition = 'all 0.3s ease-out';
    
    // Fade in
    setTimeout(() => {
      message.style.opacity = '1';
      message.style.transform = 'translateY(0)';
    }, 100);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      message.style.transition = 'all 0.5s ease-out';
      message.style.opacity = '0';
      message.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        if (message.parentNode) {
          message.remove();
        }
      }, 500);
    }, 5000);
  });

  // Form submission feedback
  const submitBtn = document.querySelector('button[type="submit"]');
  const form = document.querySelector('form');
  
  if (form && submitBtn) {
    form.addEventListener('submit', function() {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      submitBtn.classList.add('opacity-75');
    });
  }
});
</script>

{% endblock %}
